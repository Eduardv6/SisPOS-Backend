// 1. Configuración
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 2. Enums
enum TipoUsuario {
  cajero
  vendedor
  supervisor
  administrador
}

enum EstadoCaja {
  LIBRE
  OCUPADA
  CERRADA
}

enum EstadoSesionCaja {
  ABIERTA
  CERRADA
}

enum TipoDocumento {
  factura
  boleta
  ticket
}

enum EstadoVenta {
  completada
  anulada
}

enum TipoMovimientoCaja {
  INGRESO
  RETIRO
  VENTA
  APERTURA
  CIERRE
}

// 3. Modelos

model Sucursal {
  id        Int       @id @default(autoincrement())
  nombre    String    @db.VarChar(100)
  direccion String?   @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  cajas     Caja[]
  usuarios  Usuario[]
  almacenes Almacen[]
  productos Producto[]

  @@map("sucursales")
}

model Caja {
  id           Int        @id @default(autoincrement())
  nombre       String     @db.VarChar(100)
  sucursalId   Int        @map("sucursal_id")
  estado       EstadoCaja @default(CERRADA)
  codigo       String?    @db.VarChar(100)
  saldoInicial Decimal    @default(0.00) @map("saldo_inicial") @db.Decimal(10, 2)
  saldoActual  Decimal    @default(0.00) @map("saldo_actual") @db.Decimal(10, 2)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  sucursal    Sucursal      @relation(fields: [sucursalId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  sesiones    SesionCaja[]
  usuariosAsignados Usuario[]

  @@map("cajas")
}

model Usuario {
  id         Int         @id @default(autoincrement())
  nombres    String      @db.VarChar(100)
  email      String      @unique @db.VarChar(100)
  contrasena String      @db.VarChar(255)
  nroDoc     String?     @map("nro_doc") @db.VarChar(20)
  telefono   String?     @db.VarChar(20)
  tipo       TipoUsuario @default(cajero)
  estado     Boolean     @default(true)
  sucursalId Int?        @map("sucursal_id")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  sucursal          Sucursal?          @relation(fields: [sucursalId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  // Nueva relación: Caja asignada al usuario (para cajeros)
  cajaId            Int?               @map("caja_id")
  caja              Caja?              @relation(fields: [cajaId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  
  permisos          PermisoUsuario[]
  sesionesCaja      SesionCaja[]
  ventas            Venta[]
  movimientosCaja   MovimientoCaja[]
  compras           Compra[]
  movimientosInventario MovimientoInventario[]

  @@map("usuarios")
}

model PermisoUsuario {
  usuarioId Int    @map("usuario_id")
  permiso   String @db.VarChar(50)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@id([usuarioId, permiso])
  @@map("permisos_usuarios")
}

model Categoria {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(100)
  activa      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  productos Producto[]

  @@map("categorias")
}

model Producto {
  id              Int      @id @default(autoincrement())
  nombre          String   @db.VarChar(150)
  categoriaId     Int      @map("categoria_id")
  sucursalId      Int      @map("sucursal_id")
  almacenId       Int      @map("almacen_id")
  talla           String?  @db.VarChar(100) // Ej: "38, 39, 40, M, L, XL"
  color           String?  @db.VarChar(100) // Ej: "Negro, Blanco, Rojo"
  precioCompra    Decimal  @default(0.00) @map("precio_compra") @db.Decimal(10, 2)
  precioVenta     Decimal  @default(0.00) @map("precio_venta") @db.Decimal(10, 2)
  codigoBarras    String?  @map("codigo_barras") @db.VarChar(100)
  codigoInterno   String?  @map("codigo_interno") @db.VarChar(100)
  stock           Int      @default(0)
  stockMinimo     Int      @default(0) @map("stock_minimo")
  imagen          String?  @db.VarChar(255) // URL de la imagen del producto
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  categoria       Categoria        @relation(fields: [categoriaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  sucursal        Sucursal         @relation(fields: [sucursalId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  almacen         Almacen          @relation(fields: [almacenId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  inventarios     Inventario[]
  detalleVentas   DetalleVenta[]
  detalleCompras  DetalleCompra[]
  movimientosInventario MovimientoInventario[]

  @@map("productos")
}

model Almacen {
  id         Int      @id @default(autoincrement())
  nombre     String   @db.VarChar(100)
  sucursalId Int      @map("sucursal_id")
  ubicacion  String?  @db.VarChar(255)
  createdAt  DateTime @default(now()) @map("created_at")

  sucursal    Sucursal     @relation(fields: [sucursalId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  inventarios Inventario[]
  productos   Producto[]
  movimientosInventario MovimientoInventario[]

  @@map("almacenes")
}

model Inventario {
  id              Int     @id @default(autoincrement())
  productoId      Int     @map("producto_id")
  almacenId       Int     @map("almacen_id")
  cantidad        Decimal @default(0) @db.Decimal(10, 2)
  ubicacionFisica String? @map("ubicacion_fisica") @db.VarChar(100)

  producto Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  almacen  Almacen  @relation(fields: [almacenId], references: [id], onDelete: Cascade)

  @@unique([productoId, almacenId], name: "unique_stock")
  @@map("inventario")
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE
}

model MovimientoInventario {
  id          Int            @id @default(autoincrement())
  productoId  Int            @map("producto_id")
  almacenId   Int            @map("almacen_id")
  tipo        TipoMovimiento
  cantidad    Decimal        @db.Decimal(10, 2)
  motivo      String?        @db.VarChar(255) // Ej: "Venta #123", "Compra #456", "Ajuste manual"
  referencia  String?        // ID de venta, compra, etc.
  usuarioId   Int?           @map("usuario_id") // Quien hizo el movimiento
  createdAt   DateTime       @default(now()) @map("created_at")

  producto    Producto       @relation(fields: [productoId], references: [id], onDelete: Cascade)
  almacen     Almacen        @relation(fields: [almacenId], references: [id], onDelete: Cascade)
  usuario     Usuario?       @relation(fields: [usuarioId], references: [id])

  @@map("movimientos_inventario")
}

model Cliente {
  id           Int      @id @default(autoincrement())
  nombre       String   @db.VarChar(150)
  nroDocumento String?  @map("nro_documento") @db.VarChar(20)
  celular      String?  @db.VarChar(20)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  ventas Venta[]

  @@map("clientes")
}

model Proveedor {
  id        Int      @id @default(autoincrement())
  nombre    String   @db.VarChar(150)
  direccion String?  @db.Text
  celular   String?  @db.VarChar(20)
  contacto  String?  @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  compras Compra[]

  @@map("proveedores")
}

model SesionCaja {
  id           Int              @id @default(autoincrement())
  cajaId       Int              @map("caja_id")
  usuarioId    Int              @map("usuario_id")
  fechaInicio  DateTime         @default(now()) @map("fecha_inicio")
  fechaFin     DateTime?        @map("fecha_fin")
  montoInicial Decimal          @default(0.00) @map("monto_inicial") @db.Decimal(10, 2)
  montoFinal   Decimal?         @map("monto_final") @db.Decimal(10, 2)
  estado       EstadoSesionCaja @default(ABIERTA)

  caja       Caja             @relation(fields: [cajaId], references: [id])
  usuario    Usuario          @relation(fields: [usuarioId], references: [id])
  ventas     Venta[]
  movimientos MovimientoCaja[]

  @@map("sesiones_caja")
}

model Venta {
  id              Int           @id @default(autoincrement())
  fecha           DateTime      @default(now())
  clienteId       Int?          @map("cliente_id")
  usuarioId       Int           @map("usuario_id")
  sucursalId      Int           @map("sucursal_id")
  cajaId          Int           @map("caja_id")
  sesionCajaId    Int           @map("sesion_caja_id")
  tipoDocumento   TipoDocumento @default(ticket) @map("tipo_documento")
  numeroDocumento String?       @map("numero_documento") @db.VarChar(50)
  metodoPago      String        @default("efectivo") @map("metodo_pago") @db.VarChar(50)
  total           Decimal       @db.Decimal(10, 2)
  estado          EstadoVenta   @default(completada)
  createdAt       DateTime      @default(now()) @map("created_at")

  cliente    Cliente?       @relation(fields: [clienteId], references: [id])
  usuario    Usuario        @relation(fields: [usuarioId], references: [id])
  sesionCaja SesionCaja     @relation(fields: [sesionCajaId], references: [id])
  detalles   DetalleVenta[]

  @@map("ventas")
}

model DetalleVenta {
  id             Int     @id @default(autoincrement())
  ventaId        Int     @map("venta_id")
  productoId     Int     @map("producto_id")
  cantidad       Int
  precioUnitario Decimal @map("precio_unitario") @db.Decimal(10, 2)
  precioCompra   Decimal @default(0) @map("precio_compra") @db.Decimal(10, 2) // Costo histórico para reportes de utilidad
  subtotal       Decimal @db.Decimal(10, 2)

  venta    Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  producto Producto @relation(fields: [productoId], references: [id])

  @@map("detalle_ventas")
}

model MovimientoCaja {
  id           Int                @id @default(autoincrement())
  sesionCajaId Int                @map("sesion_caja_id")
  usuarioId    Int                @map("usuario_id")
  tipo         TipoMovimientoCaja
  monto        Decimal            @db.Decimal(10, 2)
  motivo       String?            @db.Text
  fecha        DateTime           @default(now())

  sesionCaja SesionCaja @relation(fields: [sesionCajaId], references: [id])
  usuario    Usuario    @relation(fields: [usuarioId], references: [id])

  @@map("movimientos_caja")
}

model Compra {
  id               Int      @id @default(autoincrement())
  proveedorId      Int      @map("proveedor_id")
  usuarioId        Int      @map("usuario_id")
  sucursalId       Int      @map("sucursal_id")
  fecha            DateTime @default(now())
  total            Decimal  @db.Decimal(10, 2)
  numeroComprobante String? @map("numero_comprobante") @db.VarChar(50)

  proveedor Proveedor       @relation(fields: [proveedorId], references: [id])
  usuario   Usuario         @relation(fields: [usuarioId], references: [id])
  detalles  DetalleCompra[]

  @@map("compras")
}

model DetalleCompra {
  id           Int     @id @default(autoincrement())
  compraId     Int     @map("compra_id")
  productoId   Int     @map("producto_id")
  cantidad     Int
  precioCompra Decimal @map("precio_compra") @db.Decimal(10, 2)
  subtotal     Decimal @db.Decimal(10, 2)

  compra   Compra   @relation(fields: [compraId], references: [id], onDelete: Cascade)
  producto Producto @relation(fields: [productoId], references: [id])

  @@map("detalle_compras")
}